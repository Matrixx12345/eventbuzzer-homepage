// Schweizer Orte-Datenbank für Reverse-Geocoding
// Format: { name, lat, lng }

export const swissPlaces = [
  // Große Städte
  { name: "Zürich", lat: 47.3769, lng: 8.5417 },
  { name: "Genf", lat: 46.2044, lng: 6.1432 },
  { name: "Basel", lat: 47.5596, lng: 7.5886 },
  { name: "Bern", lat: 46.948, lng: 7.4474 },
  { name: "Lausanne", lat: 46.5197, lng: 6.6323 },
  { name: "Winterthur", lat: 47.4984, lng: 8.7246 },
  { name: "Luzern", lat: 47.0502, lng: 8.3093 },
  { name: "St. Gallen", lat: 47.4245, lng: 9.3767 },
  { name: "Lugano", lat: 46.0037, lng: 8.9511 },
  { name: "Biel/Bienne", lat: 47.1368, lng: 7.2467 },
  
  // Mittelgroße Städte
  { name: "Thun", lat: 46.758, lng: 7.6280 },
  { name: "Köniz", lat: 46.9244, lng: 7.4144 },
  { name: "La Chaux-de-Fonds", lat: 47.1035, lng: 6.8296 },
  { name: "Schaffhausen", lat: 47.6958, lng: 8.6350 },
  { name: "Fribourg", lat: 46.8065, lng: 7.1620 },
  { name: "Chur", lat: 46.8503, lng: 9.5334 },
  { name: "Neuchâtel", lat: 46.9920, lng: 6.9293 },
  { name: "Vernier", lat: 46.2170, lng: 6.0850 },
  { name: "Uster", lat: 47.3500, lng: 8.7167 },
  { name: "Sion", lat: 46.2293, lng: 7.3586 },
  { name: "Lancy", lat: 46.1833, lng: 6.1167 },
  { name: "Emmen", lat: 47.0833, lng: 8.3000 },
  { name: "Yverdon-les-Bains", lat: 46.7785, lng: 6.6410 },
  { name: "Zug", lat: 47.1724, lng: 8.5173 },
  { name: "Kriens", lat: 47.0333, lng: 8.2833 },
  { name: "Rapperswil-Jona", lat: 47.2269, lng: 8.8186 },
  { name: "Dübendorf", lat: 47.3969, lng: 8.6186 },
  { name: "Dietikon", lat: 47.4044, lng: 8.4000 },
  { name: "Montreux", lat: 46.4312, lng: 6.9107 },
  { name: "Frauenfeld", lat: 47.5586, lng: 8.8983 },
  { name: "Wetzikon", lat: 47.3167, lng: 8.8000 },
  { name: "Carouge", lat: 46.1833, lng: 6.1333 },
  { name: "Wädenswil", lat: 47.2333, lng: 8.6667 },
  { name: "Muttenz", lat: 47.5225, lng: 7.6456 },
  { name: "Riehen", lat: 47.5833, lng: 7.6500 },
  { name: "Baar", lat: 47.1961, lng: 8.5297 },
  { name: "Allschwil", lat: 47.5500, lng: 7.5333 },
  { name: "Horgen", lat: 47.2667, lng: 8.6000 },
  { name: "Bulle", lat: 46.6167, lng: 7.0500 },
  { name: "Reinach", lat: 47.4931, lng: 7.5933 },
  { name: "Kreuzlingen", lat: 47.6500, lng: 9.1833 },
  { name: "Baden", lat: 47.4734, lng: 8.3063 },
  { name: "Wil", lat: 47.4614, lng: 9.0456 },
  { name: "Adliswil", lat: 47.3167, lng: 8.5333 },
  { name: "Volketswil", lat: 47.3833, lng: 8.6833 },
  { name: "Renens", lat: 46.5333, lng: 6.5833 },
  { name: "Gossau", lat: 47.4167, lng: 9.2500 },
  { name: "Nyon", lat: 46.3833, lng: 6.2333 },
  { name: "Schlieren", lat: 47.3967, lng: 8.4500 },
  { name: "Pratteln", lat: 47.5167, lng: 7.6833 },
  { name: "Bellinzona", lat: 46.1950, lng: 9.0239 },
  { name: "Pully", lat: 46.5167, lng: 6.6667 },
  { name: "Kloten", lat: 47.4500, lng: 8.5833 },
  { name: "Opfikon", lat: 47.4333, lng: 8.5667 },
  { name: "Wallisellen", lat: 47.4167, lng: 8.6000 },
  { name: "Regensdorf", lat: 47.4333, lng: 8.4667 },
  { name: "Meyrin", lat: 46.2333, lng: 6.0833 },
  { name: "Bülach", lat: 47.5167, lng: 8.5333 },
  { name: "Morges", lat: 46.5167, lng: 6.5000 },
  { name: "Olten", lat: 47.3500, lng: 7.9000 },
  { name: "Grenchen", lat: 47.1833, lng: 7.4000 },
  { name: "Locarno", lat: 46.1667, lng: 8.8000 },
  { name: "Thalwil", lat: 47.2833, lng: 8.5667 },
  { name: "Martigny", lat: 46.1000, lng: 7.0833 },
  { name: "Mendrisio", lat: 45.8667, lng: 8.9833 },
  { name: "Wohlen", lat: 47.3500, lng: 8.2833 },
  { name: "Binningen", lat: 47.5333, lng: 7.5667 },
  { name: "Solothurn", lat: 47.2086, lng: 7.5372 },
  { name: "Onex", lat: 46.1833, lng: 6.1000 },
  { name: "Ostermundigen", lat: 46.9667, lng: 7.5000 },
  { name: "Vevey", lat: 46.4667, lng: 6.8500 },
  { name: "Langenthal", lat: 47.2167, lng: 7.7833 },
  { name: "Burgdorf", lat: 47.0500, lng: 7.6333 },
  { name: "Steffisburg", lat: 46.7833, lng: 7.6333 },
  { name: "Brugg", lat: 47.4833, lng: 8.2000 },
  { name: "Aarau", lat: 47.3925, lng: 8.0442 },
  { name: "Arbon", lat: 47.5167, lng: 9.4333 },
  { name: "Sierre", lat: 46.2917, lng: 7.5353 },
  
  // Touristische Orte & kleinere Gemeinden
  { name: "Interlaken", lat: 46.6863, lng: 7.8632 },
  { name: "Zermatt", lat: 46.0207, lng: 7.7491 },
  { name: "Davos", lat: 46.8027, lng: 9.8360 },
  { name: "St. Moritz", lat: 46.4908, lng: 9.8355 },
  { name: "Grindelwald", lat: 46.6244, lng: 8.0414 },
  { name: "Wengen", lat: 46.6083, lng: 7.9222 },
  { name: "Mürren", lat: 46.5589, lng: 7.8928 },
  { name: "Lauterbrunnen", lat: 46.5936, lng: 7.9086 },
  { name: "Engelberg", lat: 46.8194, lng: 8.4014 },
  { name: "Andermatt", lat: 46.6358, lng: 8.5939 },
  { name: "Arosa", lat: 46.7833, lng: 9.6833 },
  { name: "Lenzerheide", lat: 46.7333, lng: 9.5500 },
  { name: "Flims", lat: 46.8333, lng: 9.2833 },
  { name: "Laax", lat: 46.8167, lng: 9.2500 },
  { name: "Klosters", lat: 46.8833, lng: 9.8833 },
  { name: "Saas-Fee", lat: 46.1083, lng: 7.9278 },
  { name: "Verbier", lat: 46.0958, lng: 7.2286 },
  { name: "Crans-Montana", lat: 46.3167, lng: 7.4833 },
  { name: "Leukerbad", lat: 46.3833, lng: 7.6333 },
  { name: "Gstaad", lat: 46.4750, lng: 7.2861 },
  { name: "Adelboden", lat: 46.4917, lng: 7.5583 },
  { name: "Kandersteg", lat: 46.4944, lng: 7.6750 },
  { name: "Meiringen", lat: 46.7250, lng: 8.1861 },
  { name: "Brienz", lat: 46.7500, lng: 8.0333 },
  { name: "Spiez", lat: 46.6833, lng: 7.6833 },
  { name: "Ascona", lat: 46.1500, lng: 8.7667 },
  { name: "Locarno", lat: 46.1667, lng: 8.7833 },
  { name: "Chiasso", lat: 45.8333, lng: 9.0333 },
  { name: "Stein am Rhein", lat: 47.6592, lng: 8.8597 },
  { name: "Appenzell", lat: 47.3306, lng: 9.4089 },
  { name: "Einsiedeln", lat: 47.1333, lng: 8.7500 },
  { name: "Schwyz", lat: 47.0167, lng: 8.6500 },
  { name: "Stans", lat: 46.9583, lng: 8.3667 },
  { name: "Sarnen", lat: 46.8961, lng: 8.2456 },
  { name: "Altdorf", lat: 46.8808, lng: 8.6378 },
  { name: "Glarus", lat: 47.0408, lng: 9.0683 },
  { name: "Liestal", lat: 47.4850, lng: 7.7344 },
  { name: "Delémont", lat: 47.3656, lng: 7.3433 },
  { name: "Porrentruy", lat: 47.4150, lng: 7.0744 },
  { name: "Rorschach", lat: 47.4833, lng: 9.5000 },
  { name: "Herisau", lat: 47.3833, lng: 9.2833 },
  { name: "Romanshorn", lat: 47.5667, lng: 9.3833 },
  { name: "Amriswil", lat: 47.5500, lng: 9.3000 },
  { name: "Weinfelden", lat: 47.5667, lng: 9.1000 },
  { name: "Buchs", lat: 47.1667, lng: 9.4667 },
  { name: "Altstätten", lat: 47.3833, lng: 9.5500 },
  { name: "Uznach", lat: 47.2333, lng: 8.9833 },
  { name: "Wattwil", lat: 47.3000, lng: 9.0833 },
  { name: "Lichtensteig", lat: 47.3333, lng: 9.0833 },
  { name: "Pfäffikon", lat: 47.2000, lng: 8.7833 },
  { name: "Meilen", lat: 47.2667, lng: 8.6333 },
  { name: "Küsnacht", lat: 47.3167, lng: 8.5833 },
  { name: "Zollikon", lat: 47.3500, lng: 8.5667 },
  { name: "Rüschlikon", lat: 47.3000, lng: 8.5500 },
  { name: "Kilchberg", lat: 47.3167, lng: 8.5500 },
  { name: "Herrliberg", lat: 47.2833, lng: 8.6167 },
  { name: "Stäfa", lat: 47.2333, lng: 8.7333 },
  { name: "Männedorf", lat: 47.2500, lng: 8.7000 },
  { name: "Richterswil", lat: 47.2000, lng: 8.7000 },
  { name: "Wollerau", lat: 47.1833, lng: 8.7167 },
  { name: "Freienbach", lat: 47.2000, lng: 8.7500 },
  { name: "Lachen", lat: 47.2000, lng: 8.8500 },
  { name: "Altendorf", lat: 47.1833, lng: 8.8333 },
  { name: "Einsiedeln", lat: 47.1167, lng: 8.7500 },
  { name: "Rotkreuz", lat: 47.1500, lng: 8.4333 },
  { name: "Cham", lat: 47.1833, lng: 8.4667 },
  { name: "Hünenberg", lat: 47.1833, lng: 8.4333 },
  { name: "Steinhausen", lat: 47.2000, lng: 8.4833 },
  { name: "Muri", lat: 47.2667, lng: 8.3333 },
  { name: "Bremgarten", lat: 47.3500, lng: 8.3333 },
  { name: "Mellingen", lat: 47.4167, lng: 8.2667 },
  { name: "Lenzburg", lat: 47.3833, lng: 8.1833 },
  { name: "Zofingen", lat: 47.2833, lng: 7.9500 },
  { name: "Sursee", lat: 47.1667, lng: 8.1167 },
  { name: "Willisau", lat: 47.1167, lng: 7.9833 },
  { name: "Hochdorf", lat: 47.1667, lng: 8.2833 },
  { name: "Sempach", lat: 47.1333, lng: 8.1833 },
  { name: "Nottwil", lat: 47.1333, lng: 8.1333 },
  { name: "Beromünster", lat: 47.2000, lng: 8.1833 },
  { name: "Schötz", lat: 47.1667, lng: 7.9833 },
  { name: "Dagmersellen", lat: 47.2167, lng: 7.9833 },
  { name: "Nebikon", lat: 47.1833, lng: 7.9667 },
  { name: "Reiden", lat: 47.2500, lng: 7.9667 },
  { name: "Pfaffnau", lat: 47.2333, lng: 7.8833 },
  { name: "Roggwil", lat: 47.2333, lng: 7.8333 },
  { name: "Aarburg", lat: 47.3167, lng: 7.9000 },
  { name: "Rothrist", lat: 47.3000, lng: 7.8833 },
  { name: "Oftringen", lat: 47.3167, lng: 7.9333 },
  { name: "Küttigen", lat: 47.4167, lng: 8.0500 },
  { name: "Suhr", lat: 47.3667, lng: 8.0833 },
  { name: "Gränichen", lat: 47.3500, lng: 8.1000 },
  { name: "Oberentfelden", lat: 47.3500, lng: 8.0500 },
  { name: "Muhen", lat: 47.3333, lng: 8.0500 },
  { name: "Kölliken", lat: 47.3333, lng: 8.0167 },
  { name: "Safenwil", lat: 47.3167, lng: 7.9833 },
  { name: "Schönenwerd", lat: 47.3667, lng: 7.8500 },
  { name: "Gretzenbach", lat: 47.3500, lng: 7.8500 },
  { name: "Däniken", lat: 47.3500, lng: 7.9833 },
  { name: "Dulliken", lat: 47.3500, lng: 7.9500 },
  { name: "Hägendorf", lat: 47.3833, lng: 7.8333 },
  { name: "Egerkingen", lat: 47.3167, lng: 7.8000 },
  { name: "Oensingen", lat: 47.2833, lng: 7.7167 },
  { name: "Balsthal", lat: 47.3167, lng: 7.6833 },
  { name: "Niederbipp", lat: 47.2667, lng: 7.6833 },
  { name: "Wangen an der Aare", lat: 47.2333, lng: 7.6500 },
  { name: "Wiedlisbach", lat: 47.2500, lng: 7.6500 },
  { name: "Herzogenbuchsee", lat: 47.1833, lng: 7.7000 },
  { name: "Huttwil", lat: 47.1167, lng: 7.8500 },
  { name: "Rohrbach", lat: 47.1333, lng: 7.8167 },
  { name: "Sumiswald", lat: 47.0333, lng: 7.7500 },
  { name: "Langnau im Emmental", lat: 46.9500, lng: 7.7833 },
  { name: "Trubschachen", lat: 46.9167, lng: 7.8500 },
  { name: "Signau", lat: 46.9000, lng: 7.7333 },
  { name: "Konolfingen", lat: 46.8833, lng: 7.6167 },
  { name: "Münsingen", lat: 46.8667, lng: 7.5667 },
  { name: "Belp", lat: 46.8833, lng: 7.5000 },
  { name: "Worb", lat: 46.9167, lng: 7.5667 },
  { name: "Grosshöchstetten", lat: 46.9167, lng: 7.6333 },
  { name: "Zäziwil", lat: 46.9000, lng: 7.6667 },
  { name: "Bowil", lat: 46.8833, lng: 7.7167 },
  { name: "Schwarzenburg", lat: 46.8167, lng: 7.3500 },
  { name: "Riggisberg", lat: 46.8000, lng: 7.4833 },
  { name: "Gürbetal", lat: 46.8500, lng: 7.5000 },
  { name: "Wabern", lat: 46.9333, lng: 7.4500 },
  { name: "Kehrsatz", lat: 46.9167, lng: 7.4667 },
  { name: "Ittigen", lat: 46.9833, lng: 7.4833 },
  { name: "Bolligen", lat: 46.9833, lng: 7.5000 },
  { name: "Stettlen", lat: 46.9667, lng: 7.5333 },
  { name: "Vechigen", lat: 46.9500, lng: 7.5833 },
  { name: "Bäriswil", lat: 47.0000, lng: 7.5333 },
  { name: "Jegenstorf", lat: 47.0500, lng: 7.5000 },
  { name: "Münchenbuchsee", lat: 47.0167, lng: 7.4500 },
  { name: "Zollikofen", lat: 46.9833, lng: 7.4500 },
  { name: "Moosseedorf", lat: 47.0000, lng: 7.4667 },
  { name: "Urtenen-Schönbühl", lat: 47.0167, lng: 7.5000 },
  { name: "Lyss", lat: 47.0667, lng: 7.3000 },
  { name: "Aarberg", lat: 47.0500, lng: 7.2667 },
  { name: "Kerzers", lat: 46.9667, lng: 7.2000 },
  { name: "Murten", lat: 46.9333, lng: 7.1167 },
  { name: "Avenches", lat: 46.8833, lng: 7.0500 },
  { name: "Payerne", lat: 46.8167, lng: 6.9333 },
  { name: "Estavayer-le-Lac", lat: 46.8500, lng: 6.8500 },
  { name: "Romont", lat: 46.6833, lng: 6.9167 },
  { name: "Châtel-St-Denis", lat: 46.5167, lng: 6.9000 },
  { name: "Aigle", lat: 46.3167, lng: 6.9667 },
  { name: "Bex", lat: 46.2500, lng: 7.0167 },
  { name: "Villars-sur-Ollon", lat: 46.3000, lng: 7.0500 },
  { name: "Leysin", lat: 46.3500, lng: 7.0167 },
  { name: "Les Diablerets", lat: 46.3500, lng: 7.2000 },
  { name: "Château-d'Oex", lat: 46.4833, lng: 7.1333 },
  { name: "Rougemont", lat: 46.4833, lng: 7.2000 },
  { name: "Saanen", lat: 46.4833, lng: 7.2667 },
  { name: "Zweisimmen", lat: 46.5500, lng: 7.3667 },
  { name: "Lenk", lat: 46.4500, lng: 7.4333 },
  { name: "Frutigen", lat: 46.5833, lng: 7.6500 },
  { name: "Reichenbach im Kandertal", lat: 46.6167, lng: 7.6833 },
  { name: "Bönigen", lat: 46.6833, lng: 7.9000 },
  { name: "Matten bei Interlaken", lat: 46.6833, lng: 7.8667 },
  { name: "Unterseen", lat: 46.6833, lng: 7.8500 },
  { name: "Wilderswil", lat: 46.6667, lng: 7.8667 },
  { name: "Gsteig", lat: 46.3833, lng: 7.2667 },
  { name: "Saanenmöser", lat: 46.5167, lng: 7.3000 },
  { name: "Schönried", lat: 46.5000, lng: 7.2833 },
  { name: "Bettingen", lat: 47.5667, lng: 7.6667 },
  { name: "Bottmingen", lat: 47.5167, lng: 7.5667 },
  { name: "Oberwil", lat: 47.5167, lng: 7.5500 },
  { name: "Therwil", lat: 47.5000, lng: 7.5500 },
  { name: "Ettingen", lat: 47.4833, lng: 7.5500 },
  { name: "Aesch", lat: 47.4667, lng: 7.6000 },
  { name: "Pfeffingen", lat: 47.4667, lng: 7.5833 },
  { name: "Arlesheim", lat: 47.4833, lng: 7.6167 },
  { name: "Münchenstein", lat: 47.5167, lng: 7.6167 },
  { name: "Birsfelden", lat: 47.5500, lng: 7.6333 },
  { name: "Kaiseraugst", lat: 47.5333, lng: 7.7333 },
  { name: "Augst", lat: 47.5333, lng: 7.7167 },
  { name: "Füllinsdorf", lat: 47.5000, lng: 7.7333 },
  { name: "Frenkendorf", lat: 47.5000, lng: 7.7167 },
  { name: "Giebenach", lat: 47.5167, lng: 7.7500 },
  { name: "Rheinfelden", lat: 47.5500, lng: 7.8000 },
  { name: "Möhlin", lat: 47.5667, lng: 7.8500 },
  { name: "Zeiningen", lat: 47.5500, lng: 7.8833 },
  { name: "Sissach", lat: 47.4667, lng: 7.8000 },
  { name: "Gelterkinden", lat: 47.4667, lng: 7.8500 },
  { name: "Läufelfingen", lat: 47.4000, lng: 7.8333 },
  { name: "Eptingen", lat: 47.3833, lng: 7.8000 },
  { name: "Laufen", lat: 47.4167, lng: 7.5000 },
  { name: "Breitenbach", lat: 47.4000, lng: 7.5500 },
  { name: "Nunningen", lat: 47.3833, lng: 7.6000 },
  { name: "Kleinlützel", lat: 47.4167, lng: 7.4167 },
  { name: "Metzerlen", lat: 47.4500, lng: 7.4500 },
  { name: "Rodersdorf", lat: 47.4833, lng: 7.4667 },
  { name: "Hofstetten", lat: 47.4667, lng: 7.5167 },
  { name: "Dornach", lat: 47.4833, lng: 7.6167 },
  { name: "Gempen", lat: 47.4667, lng: 7.6500 },
  { name: "Hochwald", lat: 47.4500, lng: 7.6167 },
  { name: "Seewen", lat: 47.4333, lng: 7.6500 },
  { name: "Büsserach", lat: 47.3833, lng: 7.5167 },
  { name: "Wahlen", lat: 47.4000, lng: 7.5000 },
  { name: "Zwingen", lat: 47.4333, lng: 7.5333 },
  { name: "Brislach", lat: 47.4167, lng: 7.5500 },
  { name: "Nenzlingen", lat: 47.4167, lng: 7.5667 },
  { name: "Duggingen", lat: 47.4500, lng: 7.6000 },
  { name: "Grellingen", lat: 47.4333, lng: 7.5833 },
];

/**
 * Findet den nächsten Ort zu gegebenen Koordinaten
 * @returns Ortsname des nächsten Eintrags
 */
export function getNearestPlace(lat: number, lng: number): string {
  let nearest = swissPlaces[0];
  let minDist = Infinity;

  for (const place of swissPlaces) {
    // Einfache Distanzberechnung (ausreichend für kleine Distanzen)
    const dLat = (lat - place.lat) * 111; // ~111 km pro Grad Latitude
    const dLng = (lng - place.lng) * 85;  // ~85 km pro Grad Longitude in der Schweiz
    const dist = Math.sqrt(dLat * dLat + dLng * dLng);
    
    if (dist < minDist) {
      minDist = dist;
      nearest = place;
    }
  }

  return nearest.name;
}

/**
 * Findet den nächsten Ort und berechnet die Distanz
 */
export function getNearestPlaceWithDistance(lat: number, lng: number): { name: string; distance: number } {
  let nearest = swissPlaces[0];
  let minDist = Infinity;

  for (const place of swissPlaces) {
    const dLat = (lat - place.lat) * 111;
    const dLng = (lng - place.lng) * 85;
    const dist = Math.sqrt(dLat * dLat + dLng * dLng);
    
    if (dist < minDist) {
      minDist = dist;
      nearest = place;
    }
  }

  return { name: nearest.name, distance: minDist };
}

// Nur die großen Städte für Distanzberechnung
const majorCities = [
  { name: "Zürich", lat: 47.3769, lng: 8.5417 },
  { name: "Genf", lat: 46.2044, lng: 6.1432 },
  { name: "Basel", lat: 47.5596, lng: 7.5886 },
  { name: "Bern", lat: 46.948, lng: 7.4474 },
  { name: "Lausanne", lat: 46.5197, lng: 6.6323 },
  { name: "Luzern", lat: 47.0502, lng: 8.3093 },
  { name: "St. Gallen", lat: 47.4245, lng: 9.3767 },
  { name: "Lugano", lat: 46.0037, lng: 8.9511 },
  { name: "Winterthur", lat: 47.4984, lng: 8.7246 },
  { name: "Chur", lat: 46.8503, lng: 9.5334 },
];

/**
 * Berechnet Himmelsrichtung von Punkt A nach Punkt B
 */
function getDirection(fromLat: number, fromLng: number, toLat: number, toLng: number): string {
  const dLat = toLat - fromLat;
  const dLng = toLng - fromLng;
  
  const angle = Math.atan2(dLng, dLat) * (180 / Math.PI);
  
  if (angle >= -22.5 && angle < 22.5) return "N";
  if (angle >= 22.5 && angle < 67.5) return "NO";
  if (angle >= 67.5 && angle < 112.5) return "O";
  if (angle >= 112.5 && angle < 157.5) return "SO";
  if (angle >= 157.5 || angle < -157.5) return "S";
  if (angle >= -157.5 && angle < -112.5) return "SW";
  if (angle >= -112.5 && angle < -67.5) return "W";
  return "NW";
}

/**
 * Findet die nächste GROSSSTADT und berechnet Distanz + Richtung
 * Format: "Riehen, 5 km NO von Basel" oder "in Basel" wenn < 3km
 */
export function getLocationWithMajorCity(lat: number, lng: number, locationName?: string): string {
  let nearestMajor = majorCities[0];
  let minDist = Infinity;

  for (const city of majorCities) {
    const dLat = (lat - city.lat) * 111;
    const dLng = (lng - city.lng) * 85;
    const dist = Math.sqrt(dLat * dLat + dLng * dLng);
    
    if (dist < minDist) {
      minDist = dist;
      nearestMajor = city;
    }
  }

  const distance = Math.round(minDist);
  
  // Wenn in der Großstadt selbst (< 3km)
  if (distance < 3) {
    return `in ${nearestMajor.name}`;
  }
  
  // Richtung berechnen (von Großstadt zum Event)
  const direction = getDirection(nearestMajor.lat, nearestMajor.lng, lat, lng);
  
  // Wenn wir einen Ortsnamen haben, zeige: "Riehen, 5 km NO von Basel"
  if (locationName && locationName !== nearestMajor.name) {
    return `${locationName}, ${distance} km ${direction} von ${nearestMajor.name}`;
  }
  
  // Fallback: nur Distanz
  return `${distance} km ${direction} von ${nearestMajor.name}`;
}
